{"version":3,"file":"index.mjs","sources":["../../src/vite/utils.ts","../../src/vite/index.ts"],"sourcesContent":["// thumbhash/examples/browser/index.html at main · evanw/thumbhash\n\nimport { subtle } from 'uncrypto'\n\n// https://github.com/evanw/thumbhash/blob/main/examples/browser/index.html\nexport function binaryToBase64(binary: Uint8Array) {\n  return btoa(String.fromCharCode(...binary))\n}\n\n/**\n * Hashes the given data using SHA-256 algorithm.\n *\n * Official example by MDN: https://developer.mozilla.org/en-US/docs/Web/API/SubtleCrypto/digest\n * @param {Uint8Array} data - The data to be hashed\n * @returns {Promise<string>} - The SHA-256 hash of the message\n */\nasync function digestUint8ArrayDataSha256(data: Uint8Array) {\n  const hashBuffer = await subtle.digest('SHA-256', data) // hash the message\n  return Array.from(new Uint8Array(hashBuffer)) // convert buffer to byte array\n}\n\n/**\n * Simulate hash function of rollup.\n *\n * About hashing, please read the documentation of rollup:\n * https://rollupjs.org/configuration-options/#output-hashcharacters\n * https://github.com/rollup/rollup/blob/1b85663fde96d84fceaa2360dba246d3cb92789b/docs/configuration-options/index.md?plain=1#L628\n *\n * For implementation details, please read the source code of rollup:\n * https://github.com/rollup/rollup/blob/1b85663fde96d84fceaa2360dba246d3cb92789b/src/utils/FileEmitter.ts#L259\n * https://github.com/rollup/rollup/blob/1b85663fde96d84fceaa2360dba246d3cb92789b/src/utils/crypto.ts#L12\n *\n * @param {Uint8Array} data - The data to be hashed\n * @param {number} length - The length of the hash\n * @returns {Promise<string>} - The first 10 characters of the SHA-256 hash of the message\n */\nexport async function hash(data: Uint8Array, length = 10) {\n  const hashResult = await digestUint8ArrayDataSha256(data)\n  const hashBase64 = binaryToBase64(new Uint8Array(hashResult)) // convert bytes to base64 encoded string\n  if (length > 0)\n    return hashBase64.substring(0, length)\n\n  return hashBase64\n}\n\n/**\n * Normalize the base64 string to be used in the URL.\n *\n * @param {string} base64 - The base64 string to be normalized\n * @returns {string} - The normalized base64 string\n */\nexport function normalizeBase64(base64: string) {\n  return base64.replace('/', '_').replace('+', '-').replace('=', '-')\n}\n","import { join, relative } from 'node:path'\nimport { mkdir, readFile, rm, writeFile } from 'node:fs/promises'\n\nimport { type Plugin, normalizePath } from 'vite'\nimport type { SiteConfig } from 'vitepress'\n\nimport { rgbaToThumbHash, thumbHashToDataURL } from 'thumbhash'\nimport { createCanvas, loadImage } from '@napi-rs/canvas'\nimport { cyan, gray } from 'colorette'\nimport ora from 'ora'\nimport { glob } from 'glob'\n\nimport type { ThumbHash, ThumbHashCalculated } from '../types'\nimport { binaryToBase64, hash, normalizeBase64 } from './utils'\n\ninterface VitePressConfig {\n  vitepress: SiteConfig\n}\n\n/**\n * Calculate the thumbhash data for the image.\n *\n * Referenced the following implementations:\n * thumbhash/examples/browser/index.html at main · evanw/thumbhash\n * https://github.com/evanw/thumbhash/blob/main/examples/browser/index.html\n *\n * And the following implementations:\n * vite-plugin-thumbhash/packages/core/index.ts at main · cijiugechu/vite-plugin-thumbhash\n * https://github.com/cijiugechu/vite-plugin-thumbhash/blob/main/packages/core/index.ts\n *\n * @param {Uint8Array} imageData - The image data to be calculated\n * @returns {Promise<Omit<ThumbHash, 'fileName' | 'assetUrl' | 'assetUrlWithBase'>>} - The thumbhash data of the image\n */\nasync function calculateThumbHashForFile(imageData: Uint8Array): Promise<ThumbHashCalculated> {\n  const image = await loadImage(imageData)\n  const width = image.width\n  const height = image.height\n\n  const scale = 100 / Math.max(width, height)\n  const resizedWidth = Math.round(width * scale)\n  const resizedHeight = Math.round(height * scale)\n\n  // Paint the image to the canvas.\n  const canvas = createCanvas(resizedWidth, resizedHeight)\n  const context = canvas.getContext('2d')\n  context.drawImage(image, 0, 0, canvas.width, canvas.height)\n  // Retrieve back the image data for thumbhash calculation as the\n  // form of RGBA matrix.\n  const pixels = context.getImageData(0, 0, canvas.width, canvas.height)\n\n  // Easy calculation of thumbhash data.\n  const thumbHashBinary = rgbaToThumbHash(pixels.width, pixels.height, pixels.data)\n  // Encode the thumbhash data to base64 and data URL.\n  const thumbHashBase64 = binaryToBase64(thumbHashBinary)\n  const thumbHashDataURL = await thumbHashToDataURL(thumbHashBinary)\n\n  return {\n    dataBase64: thumbHashBase64,\n    dataUrl: thumbHashDataURL,\n    width: resizedWidth,\n    height: resizedHeight,\n    originalWidth: width,\n    originalHeight: height,\n  }\n}\n\nfunction createThumbHashDataFromThumbHash(\n  rootDir: string,\n  assetDir: string,\n  baseUrl: string,\n  imageFileName: string,\n  imageFullFileName: string,\n  imageFullHash: string,\n  imageFileHash: string,\n  thumbHash: ThumbHashCalculated,\n): ThumbHash {\n  const fileName = relative(rootDir, imageFileName)\n\n  const thumbhashData: ThumbHash = {\n    ...thumbHash,\n    assetFileName: normalizePath(relative(rootDir, imageFullFileName)),\n    assetFullFileName: normalizePath(imageFullFileName),\n    assetFullHash: imageFullHash,\n    assetFileHash: imageFileHash,\n    assetUrl: normalizePath(join(assetDir, fileName)),\n    assetUrlWithBase: normalizePath(join(baseUrl, assetDir, fileName)),\n  }\n\n  // Since assets url is used to refer to the image when rendered\n  // in the HTML, we need to ensure that the asset URL starts with a slash\n  // where base is not included.\n  if (!thumbhashData.assetUrlWithBase.startsWith('/'))\n    thumbhashData.assetUrlWithBase = `/${thumbhashData.assetUrlWithBase}`\n\n  return thumbhashData\n}\n\n/**\n * The Vite plugin to pre-process images and generate thumbhash data for them.\n *\n * @returns {Plugin} - The Vite plugin instance\n */\nexport function ThumbnailHashImages(): Plugin {\n  return {\n    name: '@nolebase/vitepress-plugin-thumbnail-hash/images',\n    enforce: 'pre',\n    config() {\n      return {\n        optimizeDeps: {\n          exclude: [\n            '@nolebase/vitepress-plugin-thumbnail-hash/client',\n          ],\n        },\n        ssr: {\n          noExternal: [\n            '@nolebase/vitepress-plugin-thumbnail-hash',\n          ],\n        },\n      }\n    },\n    async configResolved(config) {\n      const root = config.root\n      const vitepressConfig = (config as unknown as VitePressConfig).vitepress\n\n      const startsAt = Date.now()\n\n      const moduleNamePrefix = cyan('@nolebase/vitepress-plugin-thumbnail-hash/images')\n      const grayPrefix = gray(':')\n      const spinnerPrefix = `${moduleNamePrefix}${grayPrefix}`\n\n      const spinner = ora(`${spinnerPrefix} Prepare to generate hashes for images...`).start()\n\n      const cacheDir = join(vitepressConfig.cacheDir, '@nolebase', 'vitepress-plugin-thumbnail-hash', 'thumbhashes')\n      await mkdir(cacheDir, { recursive: true })\n      await rm(join(cacheDir, '*'), { force: true, recursive: true })\n\n      spinner.text = `${spinnerPrefix} Searching for images...`\n\n      const files = await glob(`${root}/**/*.+(jpg|jpeg|png)`, { nodir: true })\n\n      spinner.text = `${spinnerPrefix} Calculating thumbhashes for images...`\n\n      const thumbhashes = await Promise.all(files.map(async (file) => {\n        const readImageRawData = await readFile(file)\n\n        // The hash implementation is mirrored and simulated from the rollup.\n        // But it's never guaranteed to be the same as the rollup's hash.\n        const imageFullHash = await hash(readImageRawData, -1)\n        const imageFileHash = normalizeBase64(imageFullHash.substring(0, 10))\n\n        // Calculate the thumbhash data for the image as thumbhash demonstrates.\n        const calculatedThumbhashData = await calculateThumbHashForFile(readImageRawData)\n\n        // Construct the thumbhash data for the image.\n        return createThumbHashDataFromThumbHash(\n          root,\n          vitepressConfig.assetsDir,\n          vitepressConfig.site.base,\n          file,\n          file,\n          imageFullHash,\n          imageFileHash,\n          calculatedThumbhashData,\n        )\n      }))\n\n      spinner.text = `${spinnerPrefix} Aggregating calculated thumbhash data...`\n\n      const thumbhashMap: Record<string, ThumbHash> = {}\n\n      for (const thumbhash of thumbhashes)\n        thumbhashMap[thumbhash.assetFileName] = thumbhash\n\n      spinner.text = `${spinnerPrefix} Writing thumbhash data to cache...`\n\n      await writeFile(join(cacheDir, 'map.json'), JSON.stringify(thumbhashMap, null, 2))\n\n      const elapsed = Date.now() - startsAt\n      spinner.succeed(`${spinnerPrefix} Done. ${gray(`(${elapsed}ms)`)}`)\n    },\n  }\n}\n"],"names":[],"mappings":"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"}